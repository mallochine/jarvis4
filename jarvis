#!/bin/sh
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Author: Alex Guo
# Contact: chessnut@outlook.com
# Program: JARVIS.
# Purpose: Significantly ease the managing of aliases.

function _jarvis_help {
cat <<-EOF
Usage: jarvis [CMD] <file or dir> <bookmark>

Commands
  add | +   Add an alias
  del | -   Delete an alias
  all       List all bookmarks
  help      Print this help message

If no command is given, jarvis displays this help message.
EOF
}

function _jarvis_find {
  if [[ -n "$1" ]]
  then
    _jarvis_all | grep "$1"
  else
    _jarvis_all | grep $PWD
  fi
}

function _jarvis_all {
  echo -e "${green}\c"
  sed 's/^alias \| # Generated by JARVIS$//g' "${jarvis_home}/.jarvis_config/main" |
                                                                   # remove extraneous info.
      sed s/=\"/\\t/g |                                            # convert =" to a tab character.
      sed "s/\"$//g" |                                             # delete the trailing quotation.
      sed '/.*/ s/\(\w*\s\)\(.\{27\}\).*\(.\{'`expr $COLUMNS - 52`'\}\)$/\1\2...\3/' | # truncates line.
      expand -t 20                                                 # align columns.
  echo -e "${endColor}\c"
}

function _jarvis_add {
  local target cur_alias comment cmd

  cur_alias=$1
  cmd=$2

  if [[ -z "$cur_alias" ]]
  then
    cmd="cd ${target:-$PWD}"
    echo -e "Type an alias for \"${green}${cmd}${endColor}\", or ^C to quit: "
    read cur_alias
  fi

  if [[ -z "$cmd" ]]
  then
    echo -e "Type a command for \"${green}${cur_alias}${endColor}\", or ^C to quit: "
    read cmd
  fi

  if [[ -n "$cur_alias" ]]
  then
    comment="# Generated by JARVIS"
    echo "alias $cur_alias=\"${cmd}\" ${comment}" >> "$jarvis_home/.jarvis_config/main"
    _jarvis_reload
    echo "\"$cur_alias\" added as an alias."
  fi
}

function _jarvis_delete {
  local delete_alias

  if [[ -n "$1" ]]
  then
    delete_alias=$1
  else
    echo "Type an alias you wish to delete, or ^C to quit:"
    read delete_alias
  fi

  # now find the alias you wish to delete
  sed -i "/^alias ${delete_alias}=/d" "$jarvis_home/.jarvis_config/main"
  unalias $delete_alias && echo "\"${delete_alias}\" deleted."
}

function _jarvis_update {
  local src_url
  src_url=https://raw.githubusercontent.com/mallochine/jarvis4/master

  wget -r -q "$src_url/jarvis" -O "$jarvis_home/.jarvis_config/jarvis"
  echo "Updated."
}

# allow $EDITOR if set
# Credit to Mr Green and @jsks.
function _jarvis_edit {
  ${EDITOR:-vim} "$jarvis_home/.jarvis_config/main"
}

function _jarvis_reload {
  [[ ! -d "$jarvis_home/.jarvis_config" ]] && mkdir "$jarvis_home/.jarvis_config"
  [[ ! -f "$jarvis_home/.jarvis_config/main" ]] && touch "$jarvis_home/.jarvis_config/main"
  source "$jarvis_home/.jarvis_config/main"
}

function _jarvis_bootup {
  _jarvis_reload
  _jarvis_goto_default
}

function _jarvis_default {
  echo "cd $PWD" > "$jarvis_home/.jarvis_config/default"
  echo "Changed default to $PWD."
}

function _jarvis_goto_default {
  echo -e "${green}Taking you to the default working directory:${endColor}"
  source "$jarvis_home/.jarvis_config/default"
}

function jarvis {
  local cmd=${1}
  local green='\e[0;32m'
  local blue='\e[1;34m'
  local endColor='\e[0m'
  local jarvis_home=$HOME

  [[ ! -f "$jarvis_home/.jarvis" ]] && touch "$jarvis_home/.jarvis"

  # Shift parameters to filter out first $1.
  # Can't use subscripting since older zsh
  # does not support ${@:2}
  shift

  case $cmd in
  "bootup"|"start")
    _jarvis_bootup $@
  ;;
  "add"|"+")
    _jarvis_add "$@"
  ;;
  "all")
    _jarvis_all
  ;;
  "update")
    _jarvis_update
  ;;
  "edit"|"vim")
    _jarvis_edit $@
  ;;
  "del"|"-")
    _jarvis_delete $@
  ;;
  "find")
    _jarvis_find $@
  ;;
  "default")
    _jarvis_default $@
  ;;
  "help")
    _jarvis_help
  ;;
  "")
    _jarvis_goto_default
  ;;
  *)
    echo "Command not found. Try \"jarvis help\"."
  ;;
  esac
}

jarvis "bootup"
